<div class="page-header">
    <div>
        <h2>Chi tiết phiếu sửa chữa {{order.code}}</h2>
        <div class="text-muted">
            Khách hàng: <strong>{{#if order.customer_name}}{{order.customer_name}}{{else}}Khách lẻ{{/if}}</strong>
            {{#if order.customer_phone}} - {{order.customer_phone}}{{/if}}
        </div>
    </div>
    <a href="#" class="btn btn-secondary" onclick="goBack(event)">Quay lại</a>
</div>

<div class="details-container">
    <div class="row">
        <div class="col-8">
            <div class="card">
                <h3>Thông tin thiết bị</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Thiết bị</th>
                            <th>Lỗi</th>
                            <th>SL</th>
                            <th>Chi phí</th>
                            <th>Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each order.items}}
                        <tr>
                            <td>
                                <strong>{{this.device_type}}</strong><br>
                                <small>{{this.device_code}}</small>
                            </td>
                            <td>{{this.issue_description}}</td>
                            <td>{{this.quantity}}</td>
                            <td>{{formatCurrency this.repair_price}}</td>
                            <td>{{formatCurrency (multiply this.quantity this.repair_price)}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>Tổng cộng:</strong></td>
                            <td><strong>{{formatCurrency order.total_cost}}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="col-4">
            <div class="card">
                <h3>Thanh toán</h3>
                <div class="payment-summary">
                    <div class="summary-row">
                        <span>Tổng chi phí:</span>
                        <span>{{formatCurrency order.total_cost}}</span>
                    </div>
                    <div class="summary-row">
                        <span>Đã thanh toán:</span>
                        <span class="text-success">{{formatCurrency order.total_paid}}</span>
                    </div>
                    <div class="summary-row total">
                        <span>Còn lại:</span>
                        <span class="text-danger">{{formatCurrency order.remaining}}</span>
                    </div>
                </div>

                <div class="payment-actions">
                    {{#if (gt order.remaining 0)}}
                    <form action="/workshop/{{order.id}}/payment" method="POST" class="payment-form">
                        <div class="form-group">
                            <label>Thanh toán thêm:</label>
                            <input type="text" name="amount" class="form-control currency-input"
                                value="{{order.remaining}}" required>
                        </div>
                        <div class="form-group">
                            <label>Hình thức thanh toán:</label>
                            <select name="payment_method" class="form-control">
                                <option value="Chuyển khoản">Chuyển khoản</option>
                                <option value="Tiền mặt">Tiền mặt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ghi chú (tùy chọn):</label>
                            <input type="text" name="note" class="form-control" placeholder="Ghi chú thanh toán">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Xác nhận thanh toán</button>
                    </form>
                    {{else}}
                    <div class="alert alert-success">Đã thanh toán đủ</div>
                    {{/if}}
                </div>

                <div class="status-info">
                    <strong>Trạng thái:</strong>
                    {{#if (eq order.status 'IN_REPAIR')}}
                    <span class="badge badge-warning">Đang sửa</span>
                    {{else if (eq order.status 'REPAIRED_DEBT')}}
                    <span class="badge badge-info">Đã sửa - Còn nợ</span>
                    {{else if (eq order.status 'PAID')}}
                    <span class="badge badge-success">Đã thanh toán toàn bộ</span>
                    {{else if (eq order.status 'RETURNED')}}
                    <span class="badge badge-danger">Hoàn đơn</span>
                    {{/if}}
                </div>
                <p><strong>Người tạo:</strong> {{order.created_by}}</p>

                <div class="payment-history">
                    <h3>Lịch sử thanh toán</h3>
                    {{#if order.payments}}
                    <table class="table payment-history-table">
                        <thead>
                            <tr>
                                <th>Ngày</th>
                                <th>Số tiền</th>
                                <th>Hình thức</th>
                                <th>Ghi chú</th>
                                <th>Người tạo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each order.payments}}
                            <tr>
                                <td>{{formatDate this.created_at}}</td>
                                <td>{{formatCurrency this.amount}}</td>
                                <td>{{this.payment_method}}</td>
                                <td>{{this.note}}</td>
                                <td>{{this.created_by}}</td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                    {{else}}
                    <p class="text-muted">Chưa có thanh toán nào</p>
                    {{/if}}
                </div>

                <div class="status-actions">
                    <h3>Trạng thái</h3>
                    <form action="/workshop/{{order.id}}/status" method="POST">
                        <div class="form-group">
                            <select name="status" class="form-control">
                                <option value="IN_REPAIR" {{#if (eq order.status 'IN_REPAIR' )}}selected{{/if}}>Đang sửa
                                </option>
                                <option value="REPAIRED_DEBT" {{#if (eq order.status 'REPAIRED_DEBT' )}}selected{{/if}}>
                                    Đã sửa - Còn nợ</option>
                                <option value="RETURNED" {{#if (eq order.status 'RETURNED' )}}selected{{/if}}>Hoàn đơn
                                </option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-secondary btn-block">Cập nhật trạng thái</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .row {
        display: flex;
        gap: 20px;
    }

    .col-8 {
        flex: 2;
    }

    .col-4 {
        flex: 1;
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .card h3 {
        margin-bottom: 15px;
        font-size: 16px;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 10px;
    }

    .payment-summary {
        margin-bottom: 20px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .summary-row.total {
        font-weight: bold;
        border-top: 1px dashed #cbd5e1;
        padding-top: 10px;
        font-size: 16px;
    }

    .text-success {
        color: #166534;
    }

    .text-danger {
        color: #991b1b;
    }

    .btn-block {
        width: 100%;
    }

    .payment-form {
        margin-bottom: 20px;
    }

    .alert-success {
        background-color: #dcfce7;
        color: #166534;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
    }

    .btn-secondary {
        background-color: var(--secondary-color);
        color: white;
        text-decoration: none;
    }

    .payment-history {
        margin-bottom: 20px;
    }

    .table-sm {
        font-size: 14px;
    }

    .table-sm th,
    .table-sm td {
        padding: 8px;
    }

    .text-muted {
        color: #64748b;
        font-style: italic;
    }
</style>

<script>
    function goBack(event) {
        event.preventDefault();
        const urlParams = new URLSearchParams(window.location.search);
        const backUrl = urlParams.get('back');
        if (backUrl) {
            window.location.href = backUrl;
        } else {
            window.location.href = '/workshop';
        }
    }
</script>