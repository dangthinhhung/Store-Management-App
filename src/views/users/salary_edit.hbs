<div class="container">
    <div class="page-header">
        <div>
            <h1>Ch·ªânh s·ª≠a phi·∫øu l∆∞∆°ng th√°ng {{slip.month}}/{{slip.year}}</h1>
            <p class="text-muted">M√£ phi·∫øu: <strong>{{slip.code}}</strong></p>
        </div>
        <div>
            <a href="/users/salary-slips/{{slip.id}}" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
        </div>
    </div>

    <form action="/users/salary-slips/{{slip.id}}" method="POST">
        <div class="card mb-20">
            <div class="card-header">
                <h3>Nh√¢n vi√™n trong phi·∫øu l∆∞∆°ng</h3>
            </div>
            <table class="table" id="salaryTable">
                <thead>
                    <tr>
                        <th>Nh√¢n vi√™n</th>
                        <th>L∆∞∆°ng c·ª©ng</th>
                        <th>Th∆∞·ªüng</th>
                        <th>Ph·∫°t</th>
                        <th>T·ªïng</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each currentSalaries}}
                    <tr data-salary-id="{{this.id}}">
                        <td>
                            <strong>{{this.full_name}}</strong>
                            <input type="hidden" name="salary_id[]" value="{{this.id}}">
                            <input type="hidden" name="user_id[]" value="{{this.user_id}}">
                        </td>
                        <td>
                            <input type="text" class="form-control currency-input" name="amount[]"
                                value="{{this.amount}}" required>
                        </td>
                        <td>
                            <input type="text" class="form-control currency-input" name="bonus[]"
                                value="{{this.bonus}}">
                        </td>
                        <td>
                            <input type="text" class="form-control currency-input" name="penalty[]"
                                value="{{this.penalty}}">
                        </td>
                        <td class="total-cell">{{formatCurrency this.amount}}</td>
                        <td>
                            <button type="button" class="btn-icon text-danger" onclick="removeRow(this)">X√≥a</button>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>

        {{#if availableUsers.length}}
        <div class="card mb-20">
            <div class="card-header">
                <h3>Th√™m nh√¢n vi√™n v√†o phi·∫øu l∆∞∆°ng</h3>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label>Ch·ªçn nh√¢n vi√™n</label>
                    <select id="addEmployeeSelect" class="form-control">
                        <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                        {{#each availableUsers}}
                        <option value="{{this.id}}" data-name="{{this.full_name}}"
                            data-salary="{{this.default_salary}}">
                            {{this.full_name}} - {{formatCurrency this.default_salary}}
                        </option>
                        {{/each}}
                    </select>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addEmployee()">+ Th√™m v√†o phi·∫øu</button>
            </div>
        </div>
        {{/if}}

        <div class="card">
            <div class="card-header">
                <h3>Th√¥ng tin phi·∫øu l∆∞∆°ng</h3>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label>T·ªïng l∆∞∆°ng (t·ª± ƒë·ªông t√≠nh)</label>
                    <input type="text" class="form-control" id="totalAmount" readonly>
                </div>
                <div class="form-group">
                    <label>H√¨nh th·ª©c thanh to√°n</label>
                    <select name="payment_method" class="form-control">
                        <option value="Ti·ªÅn m·∫∑t" {{#if (eq slip.payment_method 'Ti·ªÅn m·∫∑t' )}}selected{{/if}}>Ti·ªÅn m·∫∑t
                        </option>
                        <option value="Chuy·ªÉn kho·∫£n" {{#if (eq slip.payment_method 'Chuy·ªÉn kho·∫£n' )}}selected{{/if}}>
                            Chuy·ªÉn kho·∫£n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ghi ch√∫</label>
                    <textarea name="note" class="form-control">{{slip.note}}</textarea>
                </div>
            </div>
        </div>

        <div style="margin-top: 20px; text-align: right;">
            <a href="/users/salary-slips/{{slip.id}}" class="btn btn-secondary">H·ªßy</a>
            <button type="submit" class="btn btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
        </div>
    </form>
</div>

<script>
    // Currency formatting
    document.querySelectorAll('.currency-input').forEach(input => {
        input.addEventListener('blur', function () {
            formatCurrencyField(this);
            calculateTotal(this.closest('tr'));
            calculateGrandTotal();
        });
    });

    function formatCurrencyField(input) {
        let value = input.value.replace(/\D/g, '');
        if (value) {
            input.value = new Intl.NumberFormat('vi-VN').format(value);
        }
    }

    function calculateTotal(row) {
        const amount = parseFloat(row.querySelector('input[name="amount[]"]').value.replace(/\D/g, '')) || 0;
        const bonus = parseFloat(row.querySelector('input[name="bonus[]"]').value.replace(/\D/g, '')) || 0;
        const penalty = parseFloat(row.querySelector('input[name="penalty[]"]').value.replace(/\D/g, '')) || 0;
        const total = amount + bonus - penalty;
        row.querySelector('.total-cell').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(total);
    }

    function calculateGrandTotal() {
        let total = 0;
        document.querySelectorAll('#salaryTable tbody tr').forEach(row => {
            const amount = parseFloat(row.querySelector('input[name="amount[]"]').value.replace(/\D/g, '')) || 0;
            const bonus = parseFloat(row.querySelector('input[name="bonus[]"]').value.replace(/\D/g, '')) || 0;
            const penalty = parseFloat(row.querySelector('input[name="penalty[]"]').value.replace(/\D/g, '')) || 0;
            total += (amount + bonus - penalty);
        });
        document.getElementById('totalAmount').value = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(total);
    }

    function removeRow(btn) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n n√†y kh·ªèi phi·∫øu l∆∞∆°ng?')) {
            btn.closest('tr').remove();
            calculateGrandTotal();
        }
    }

    function addEmployee() {
        const select = document.getElementById('addEmployeeSelect');
        const selectedOption = select.options[select.selectedIndex];

        if (!selectedOption.value) {
            alert('Vui l√≤ng ch·ªçn nh√¢n vi√™n');
            return;
        }

        const userId = selectedOption.value;
        const userName = selectedOption.dataset.name;
        const baseSalary = selectedOption.dataset.salary;

        // Add new row
        const tbody = document.querySelector('#salaryTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>
                <strong>${userName}</strong>
                <input type="hidden" name="salary_id[]" value="0">
                <input type="hidden" name="user_id[]" value="${userId}">
            </td>
            <td>
                <input type="text" class="form-control currency-input" name="amount[]" value="${new Intl.NumberFormat('vi-VN').format(baseSalary)}" required>
            </td>
            <td>
                <input type="text" class="form-control currency-input" name="bonus[]" value="0">
            </td>
            <td>
                <input type="text" class="form-control currency-input" name="penalty[]" value="0">
            </td>
            <td class="total-cell">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(baseSalary)}</td>
            <td>
                <button type="button" class="btn-icon text-danger" onclick="removeRow(this)">X√≥a</button>
            </td>
        `;
        tbody.appendChild(newRow);

        // Re-attach event listeners
        newRow.querySelectorAll('.currency-input').forEach(input => {
            input.addEventListener('blur', function () {
                formatCurrencyField(this);
                calculateTotal(this.closest('tr'));
                calculateGrandTotal();
            });
        });

        // Remove from available list
        selectedOption.remove();
        select.selectedIndex = 0;

        calculateGrandTotal();
    }

    // Initial calculation
    document.querySelectorAll('#salaryTable tbody tr').forEach(row => {
        calculateTotal(row);
    });
    calculateGrandTotal();
</script>

<style>
    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
    }

    .currency-input {
        width: 120px;
        text-align: right;
    }

    .total-cell {
        font-weight: bold;
        color: #166534;
    }

    .card-header {
        padding: 15px 20px;
        border-bottom: 1px solid #e2e8f0;
    }

    .card-header h3 {
        margin: 0;
        font-size: 16px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #475569;
    }
</style>