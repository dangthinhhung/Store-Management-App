<div class="page-header">
    <h2>B√°o c√°o doanh thu</h2>
    <div>
        <a href="/transactions" class="btn btn-secondary" style="margin-right: 10px;">L·ªãch s·ª≠ giao d·ªãch kh√°c</a>
        <button class="btn btn-primary" onclick="openModal()">+ T·∫°o giao d·ªãch</button>
    </div>
</div>

<div class="card mb-20">
    <div class="report-controls">
        <div class="btn-group">
            <a href="/reports?type=daily"
                class="btn {{#if (eq type 'daily')}}btn-primary{{else}}btn-secondary{{/if}}">Theo ng√†y</a>
            <a href="/reports?type=monthly"
                class="btn {{#if (eq type 'monthly')}}btn-primary{{else}}btn-secondary{{/if}}">Theo th√°ng</a>
            <a href="/reports?type=yearly"
                class="btn {{#if (eq type 'yearly')}}btn-primary{{else}}btn-secondary{{/if}}">Theo nƒÉm</a>
        </div>

        <form action="/reports" method="GET" class="date-picker-form">
            <input type="hidden" name="type" value="{{type}}">

            {{#if (eq type 'daily')}}
            <input type="date" name="date" class="form-control" value="{{date}}" onchange="this.form.submit()">
            {{/if}}

            {{#if (eq type 'monthly')}}
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <div style="font-weight: 600; color: #1e40af; font-size: 15px;">{{formatMonth month}}</div>
                <input type="month" name="month" class="form-control" value="{{month}}" onchange="this.form.submit()">
            </div>
            {{/if}}

            {{#if (eq type 'yearly')}}
            <select name="year" class="form-control" onchange="this.form.submit()">
                <option value="2023" {{#if (eq year '2023' )}}selected{{/if}}>2023</option>
                <option value="2024" {{#if (eq year '2024' )}}selected{{/if}}>2024</option>
                <option value="2025" {{#if (eq year '2025' )}}selected{{/if}}>2025</option>
            </select>
            {{/if}}
        </form>
    </div>
</div>

<div class="row">
    <div class="col-4">
        <div class="card summary-card bg-success-light">
            <h3>T·ªïng thu</h3>
            <div class="amount text-success">{{formatCurrency revenue}}</div>
            <div class="breakdown-modern">
                <div class="breakdown-item">
                    <span class="breakdown-icon">üíµ</span>
                    <div class="breakdown-details">
                        <span class="breakdown-label">Ti·ªÅn m·∫∑t</span>
                        <span class="breakdown-value">{{formatCurrency revenueCash}}</span>
                    </div>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-icon">üí≥</span>
                    <div class="breakdown-details">
                        <span class="breakdown-label">Chuy·ªÉn kho·∫£n</span>
                        <span class="breakdown-value">{{formatCurrency revenueTransfer}}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-4">
        <div class="card summary-card bg-danger-light">
            <h3>T·ªïng chi</h3>
            <div class="amount text-danger">{{formatCurrency expense}}</div>
            <div class="breakdown-modern">
                <div class="breakdown-item">
                    <span class="breakdown-icon">üíµ</span>
                    <div class="breakdown-details">
                        <span class="breakdown-label">Ti·ªÅn m·∫∑t</span>
                        <span class="breakdown-value">{{formatCurrency expenseCash}}</span>
                    </div>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-icon">üí≥</span>
                    <div class="breakdown-details">
                        <span class="breakdown-label">Chuy·ªÉn kho·∫£n</span>
                        <span class="breakdown-value">{{formatCurrency expenseTransfer}}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-4">
        <div class="card summary-card bg-primary-light">
            <h3>L·ª£i nhu·∫≠n</h3>
            <div class="amount text-primary">{{formatCurrency profit}}</div>
        </div>
    </div>
</div>

<div class="row mt-20">
    <div class="col-6">
        <div class="card">
            <div class="card-header-flex">
                <h3>Chi ti·∫øt thu</h3>
                <select id="revenueFilter" class="form-control form-control-sm" onchange="filterRevenue()">
                    <option value="all">T·∫•t c·∫£ ngu·ªìn</option>
                    <option value="pos">ƒê∆°n l·∫ª</option>
                    <option value="workshop">ƒê∆°n x∆∞·ªüng</option>
                    <option value="other">Kh√°c</option>
                </select>
                <select id="revenueCreatorFilter" class="form-control form-control-sm" onchange="filterRevenue()">
                    <option value="all">T·∫•t c·∫£ ng∆∞·ªùi t·∫°o</option>
                </select>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Ngu·ªìn</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Th·ªùi gian</th>
                        <th>Chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each orders}}
                    <tr class="revenue-row revenue-pos {{#if this.is_hidden}}hidden-row{{/if}}"
                        id="row-order-{{this.id}}" data-id="{{this.id}}" data-amount="{{this.final_amount}}"
                        data-type="INCOME" data-method="{{this.payment_method}}" data-created-by="{{this.created_by}}"
                        data-hidden="{{#if this.is_hidden}}true{{else}}false{{/if}}">
                        <td>
                            <a href="/pos/{{this.id}}?back=/reports" class="text-primary hover:underline">ƒê∆°n l·∫ª
                                {{this.code}}</a>
                        </td>
                        <td>{{formatCurrency this.final_amount}}</td>
                        <td>{{this.created_at}}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="/pos/{{this.id}}?back=/reports" class="btn-icon-sm">Xem</a>
                                <button type="button" class="btn-icon-sm btn-toggle-hide"
                                    onclick="toggleHide('{{this.id}}', 'order')">
                                    {{#if this.is_hidden}}Hi·ªán{{else}}·∫®n{{/if}}
                                </button>
                                <button type="button" class="btn-icon-sm text-danger"
                                    onclick="confirmDelete('{{this.id}}', 'order')">X√≥a</button>
                            </div>
                        </td>
                    </tr>
                    {{/each}}
                    {{#each workshopPayments}}
                    <tr class="revenue-row revenue-workshop {{#if this.is_hidden}}hidden-row{{/if}}"
                        id="row-workshop-{{this.id}}" data-id="{{this.id}}" data-amount="{{this.amount}}"
                        data-type="INCOME" data-method="{{this.payment_method}}" data-created-by="{{this.created_by}}"
                        data-hidden="{{#if this.is_hidden}}true{{else}}false{{/if}}">
                        <td>
                            <a href="/workshop/{{this.workshop_order_id}}?back=/reports"
                                class="text-primary hover:underline">ƒê∆°n x∆∞·ªüng {{this.code}}</a>
                        </td>
                        <td>{{formatCurrency this.amount}}</td>
                        <td>{{this.created_at}}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="/workshop/{{this.workshop_order_id}}?back=/reports" class="btn-icon-sm">Xem</a>
                                <button type="button" class="btn-icon-sm btn-toggle-hide"
                                    onclick="toggleHide('{{this.id}}', 'workshop-payment')">
                                    {{#if this.is_hidden}}Hi·ªán{{else}}·∫®n{{/if}}
                                </button>
                                <button type="button" class="btn-icon-sm text-danger"
                                    onclick="confirmDelete('{{this.id}}', 'workshop-payment')">X√≥a</button>
                            </div>
                        </td>
                    </tr>
                    {{/each}}
                    {{#each transactions}}
                    {{#if (eq this.type 'INCOME')}}
                    <tr class="revenue-row revenue-other {{#if this.is_hidden}}hidden-row{{/if}}"
                        id="row-transaction-{{this.id}}" data-id="{{this.id}}" data-amount="{{this.amount}}"
                        data-type="INCOME" data-method="{{this.payment_method}}" data-created-by="{{this.created_by}}"
                        data-hidden="{{#if this.is_hidden}}true{{else}}false{{/if}}">
                        <td>
                            {{this.transaction_name}}
                            <a href="/transactions/code/{{this.code}}"
                                class="text-primary hover:underline">{{this.code}}</a>
                        </td>
                        <td>{{formatCurrency this.amount}}</td>
                        <td>{{this.created_at}}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="/transactions/code/{{this.code}}?back=/reports" class="btn-icon-sm">Xem</a>
                                <button type="button" class="btn-icon-sm btn-toggle-hide"
                                    onclick="toggleHide('{{this.id}}', 'transaction')">
                                    {{#if this.is_hidden}}Hi·ªán{{else}}·∫®n{{/if}}
                                </button>
                                <button type="button" class="btn-icon-sm text-danger"
                                    onclick="confirmDelete('{{this.id}}', 'transaction')">X√≥a</button>
                            </div>
                        </td>
                    </tr>
                    {{/if}}
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
    <div class="col-6">
        <div class="card">
            <div class="card-header-flex">
                <h3>Chi ti·∫øt chi</h3>
                <select id="expenseFilter" class="form-control form-control-sm" onchange="filterExpense()">
                    <option value="all">T·∫•t c·∫£ lo·∫°i chi</option>
                    <option value="import">Nh·∫≠p h√†ng</option>
                    <option value="salary">Tr·∫£ l∆∞∆°ng</option>
                    <option value="other">Kh√°c</option>
                </select>
                <select id="expenseCreatorFilter" class="form-control form-control-sm" onchange="filterExpense()">
                    <option value="all">T·∫•t c·∫£ ng∆∞·ªùi t·∫°o</option>
                </select>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>M√¥ t·∫£</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Th·ªùi gian</th>
                        <th>Chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each transactions}}
                    {{#if (eq this.type 'EXPENSE')}}
                    <tr class="expense-row {{#if (contains this.description 'Nh·∫≠p h√†ng')}}expense-import{{else}}expense-other{{/if}} {{#if this.is_hidden}}hidden-row{{/if}}"
                        id="row-transaction-{{this.id}}" data-id="{{this.id}}" data-amount="{{this.amount}}"
                        data-type="EXPENSE" data-method="{{this.payment_method}}" data-created-by="{{this.created_by}}"
                        data-hidden="{{#if this.is_hidden}}true{{else}}false{{/if}}">
                        <td>
                            {{#if (contains this.description 'Nh·∫≠p h√†ng')}}
                            {{{linkTransaction this.transaction_name this.description}}}
                            {{else}}
                            {{this.transaction_name}}
                            <a href="/transactions/code/{{this.code}}"
                                class="text-primary hover:underline">{{this.code}}</a>
                            {{/if}}
                        </td>
                        <td>{{formatCurrency this.amount}}</td>
                        <td>{{this.created_at}}</td>
                        <td>
                            <div class="action-buttons">
                                {{#if (contains this.description 'Nh·∫≠p h√†ng')}}
                                <a href="/imports?back=/reports" class="btn-icon-sm">Xem</a>
                                {{else}}
                                <a href="/transactions/code/{{this.code}}?back=/reports" class="btn-icon-sm">Xem</a>
                                {{/if}}
                                <button type="button" class="btn-icon-sm btn-toggle-hide"
                                    onclick="toggleHide('{{this.id}}', 'transaction')">
                                    {{#if this.is_hidden}}Hi·ªán{{else}}·∫®n{{/if}}
                                </button>
                                <button type="button" class="btn-icon-sm text-danger"
                                    onclick="confirmDelete('{{this.id}}', 'transaction')">X√≥a</button>
                            </div>
                        </td>
                    </tr>
                    {{/if}}
                    {{/each}}
                    {{#each salarySlips}}
                    <tr class="expense-row expense-salary {{#if this.is_hidden}}hidden-row{{/if}}"
                        id="row-salary-{{this.id}}" data-id="{{this.id}}" data-amount="{{this.total_amount}}"
                        data-type="EXPENSE" data-method="{{this.payment_method}}" data-created-by="{{this.created_by}}"
                        data-hidden="{{#if this.is_hidden}}true{{else}}false{{/if}}">
                        <td>
                            <a href="/users/salary-slips/{{this.id}}" class="transaction-link">{{this.code}}</a> - L∆∞∆°ng
                            th√°ng {{this.month}}/{{this.year}}
                        </td>
                        <td>{{formatCurrency this.total_amount}}</td>
                        <td>{{formatDateTime this.payment_date}}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="/users/salary-slips/{{this.id}}" class="btn-icon-sm">Xem</a>
                                <button type="button" class="btn-icon-sm btn-toggle-hide"
                                    onclick="toggleHide('{{this.id}}', 'salary')">
                                    {{#if this.is_hidden}}Hi·ªán{{else}}·∫®n{{/if}}
                                </button>
                                <button type="button" class="btn-icon-sm text-danger"
                                    onclick="confirmDelete('{{this.id}}', 'salary')">X√≥a</button>
                            </div>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
</div>

</div>

<!-- Create Transaction Modal -->
<div id="transactionModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>T·∫°o giao d·ªãch m·ªõi</h3>
        <form action="/reports/transaction" method="POST">
            <div class="form-group">
                <label>Lo·∫°i giao d·ªãch</label>
                <select name="type" class="form-control" required>
                    <option value="INCOME">Thu (Income)</option>
                    <option value="EXPENSE">Chi (Expense)</option>
                </select>
            </div>
            <div class="form-group">
                <label>T√™n giao d·ªãch</label>
                <input type="text" name="transaction_name" class="form-control"
                    placeholder="VD: B√°n ph·ª• ki·ªán, Thu√™ m·∫∑t b·∫±ng..." required>
            </div>
            <div class="form-group">
                <label>S·ªë ti·ªÅn</label>
                <input type="text" name="amount" class="form-control currency-input" required>
            </div>
            <div class="form-group">
                <label>M√¥ t·∫£</label>
                <input type="text" name="description" class="form-control" placeholder="Chi ti·∫øt v·ªÅ giao d·ªãch">
            </div>
            <div class="form-group">
                <label>H√¨nh th·ª©c thanh to√°n</label>
                <select name="payment_method" class="form-control">
                    <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
                    <option value="Chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ng√†y giao d·ªãch</label>
                <input type="date" name="transaction_date" class="form-control" value="{{currentDate}}">
            </div>
            <div class="form-group">
                <label>Kh√°ch h√†ng (T√πy ch·ªçn)</label>
                <input type="text" id="customerSearchTransaction" class="form-control" placeholder="T√¨m kh√°ch h√†ng..."
                    autocomplete="off">
                <input type="hidden" name="customer_id" id="customerIdTransaction">
                <div id="customerResultsTransaction" class="search-results"></div>
            </div>
            <div class="form-group">
                <label>Ghi ch√∫</label>
                <textarea name="note" class="form-control"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-block">L∆∞u giao d·ªãch</button>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <span class="close" onclick="closeDeleteModal()">&times;</span>
        <h3>X√°c nh·∫≠n x√≥a</h3>
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">H·ªßy</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">X√≥a vƒ©nh vi·ªÖn</button>
        </div>
    </div>
</div>

<script>
    function openModal() {
        document.getElementById('transactionModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('transactionModal').style.display = 'none';
    }

    let deleteId = null;
    let deleteType = null;

    function confirmDelete(id, type) {
        deleteId = id;
        deleteType = type;
        document.getElementById('deleteConfirmModal').style.display = 'block';
    }

    function closeDeleteModal() {
        deleteId = null;
        deleteType = null;
        document.getElementById('deleteConfirmModal').style.display = 'none';
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        if (!deleteId || !deleteType) return;

        // AJAX Delete
        fetch(`/reports/${deleteType}/${deleteId}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI
                    const row = document.getElementById(`row-${deleteType}-${deleteId}`);
                    if (row) {
                        // Only subtract if it wasn't hidden
                        const isHidden = row.getAttribute('data-hidden') === 'true';
                        if (!isHidden) {
                            updateTotals(row, 'remove');
                        }
                        row.remove();
                    }
                    closeDeleteModal();
                } else {
                    alert('C√≥ l·ªói x·∫£y ra: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a giao d·ªãch');
            });
    });

    function toggleHide(id, type) {
        fetch(`/reports/${type}/${id}/toggle-hide`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const row = document.getElementById(`row-${type}-${id}`);
                    const isHidden = row.getAttribute('data-hidden') === 'true';
                    const btn = row.querySelector('.btn-toggle-hide');
                    const badge = row.querySelector('.badge');

                    if (isHidden) {
                        // Unhide
                        row.classList.remove('hidden-row');
                        row.setAttribute('data-hidden', 'false');
                        btn.textContent = '·∫®n';
                        if (badge) badge.classList.add('hidden');
                        updateTotals(row, 'add');
                    } else {
                        // Hide
                        row.classList.add('hidden-row');
                        row.setAttribute('data-hidden', 'true');
                        btn.textContent = 'Hi·ªán';
                        if (badge) badge.classList.remove('hidden');
                        updateTotals(row, 'remove');
                    }
                } else {
                    alert('C√≥ l·ªói x·∫£y ra: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('C√≥ l·ªói x·∫£y ra');
            });
    }

    function updateTotals(row, action) {
        const amount = parseFloat(row.getAttribute('data-amount'));
        const type = row.getAttribute('data-type'); // INCOME or EXPENSE
        const method = row.getAttribute('data-method'); // Ti·ªÅn m·∫∑t or Chuy·ªÉn kho·∫£n

        // Selectors for totals
        const totalRevenueEl = document.querySelector('.bg-success-light .amount');
        const totalExpenseEl = document.querySelector('.bg-danger-light .amount');
        const profitEl = document.querySelector('.bg-primary-light .amount');

        // Helper to parse currency string to number
        const parseMoney = (str) => {
            return parseFloat(str.replace(/\./g, '').replace(' ‚Ç´', '').replace(/,/g, '')) || 0;
        };

        // Helper to format number to currency
        const formatMoney = (num) => {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num);
        };

        let currentRevenue = parseMoney(totalRevenueEl.textContent);
        let currentExpense = parseMoney(totalExpenseEl.textContent);

        if (type === 'INCOME') {
            if (action === 'add') {
                currentRevenue += amount;
            } else {
                currentRevenue -= amount;
            }
            totalRevenueEl.textContent = formatMoney(currentRevenue);

            // Update breakdown with new structure
            const breakdownItems = document.querySelectorAll('.bg-success-light .breakdown-item');
            breakdownItems.forEach(item => {
                const label = item.querySelector('.breakdown-label').textContent;
                const valueEl = item.querySelector('.breakdown-value');

                if ((method === 'Ti·ªÅn m·∫∑t' && label === 'Ti·ªÅn m·∫∑t') ||
                    (method === 'Chuy·ªÉn kho·∫£n' && label === 'Chuy·ªÉn kho·∫£n')) {
                    let val = parseMoney(valueEl.textContent);
                    val = action === 'add' ? val + amount : val - amount;
                    valueEl.textContent = formatMoney(val);
                }
            });

        } else if (type === 'EXPENSE') {
            if (action === 'add') {
                currentExpense += amount;
            } else {
                currentExpense -= amount;
            }
            totalExpenseEl.textContent = formatMoney(currentExpense);

            // Update breakdown with new structure
            const breakdownItems = document.querySelectorAll('.bg-danger-light .breakdown-item');
            breakdownItems.forEach(item => {
                const label = item.querySelector('.breakdown-label').textContent;
                const valueEl = item.querySelector('.breakdown-value');

                if ((method === 'Ti·ªÅn m·∫∑t' && label === 'Ti·ªÅn m·∫∑t') ||
                    (method === 'Chuy·ªÉn kho·∫£n' && label === 'Chuy·ªÉn kho·∫£n')) {
                    let val = parseMoney(valueEl.textContent);
                    val = action === 'add' ? val + amount : val - amount;
                    valueEl.textContent = formatMoney(val);
                }
            });
        }

        // Update Profit
        profitEl.textContent = formatMoney(currentRevenue - currentExpense);
    }

    function filterRevenue() {
        const typeFilter = document.getElementById('revenueFilter').value;
        const creatorFilter = document.getElementById('revenueCreatorFilter').value;
        const rows = document.querySelectorAll('.revenue-row');

        rows.forEach(row => {
            const rowType = row.classList.contains('revenue-pos') ? 'pos' :
                row.classList.contains('revenue-workshop') ? 'workshop' : 'other';
            const rowCreator = row.getAttribute('data-created-by') || 'admin';

            let show = true;
            if (typeFilter !== 'all' && rowType !== typeFilter) show = false;
            if (creatorFilter !== 'all' && rowCreator !== creatorFilter) show = false;

            row.style.display = show ? '' : 'none';
        });
    }

    function filterExpense() {
        const typeFilter = document.getElementById('expenseFilter').value;
        const creatorFilter = document.getElementById('expenseCreatorFilter').value;
        const rows = document.querySelectorAll('.expense-row');

        rows.forEach(row => {
            const rowType = row.classList.contains('expense-import') ? 'import' :
                row.classList.contains('expense-salary') ? 'salary' : 'other';
            const rowCreator = row.getAttribute('data-created-by') || 'admin';

            let show = true;
            if (typeFilter !== 'all' && rowType !== typeFilter) show = false;
            if (creatorFilter !== 'all' && rowCreator !== creatorFilter) show = false;

            row.style.display = show ? '' : 'none';
        });
    }

    // Populate creator filters on load
    document.addEventListener('DOMContentLoaded', function () {
        const populateFilter = (rowsSelector, filterId) => {
            const rows = document.querySelectorAll(rowsSelector);
            const creators = new Set();
            rows.forEach(row => {
                const creator = row.getAttribute('data-created-by');
                if (creator) creators.add(creator);
            });

            const filter = document.getElementById(filterId);
            Array.from(creators).sort().forEach(creator => {
                const option = document.createElement('option');
                option.value = creator;
                option.textContent = creator;
                filter.appendChild(option);
            });
        };

        populateFilter('.revenue-row', 'revenueCreatorFilter');
        populateFilter('.expense-row', 'expenseCreatorFilter');
    });

    window.onclick = function (event) {
        const modal = document.getElementById('transactionModal');
        const deleteModal = document.getElementById('deleteConfirmModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
        if (event.target == deleteModal) {
            deleteModal.style.display = "none";
        }
    }

    // Customer search for transaction modal
    const customerSearchTransaction = document.getElementById('customerSearchTransaction');
    const customerResultsTransaction = document.getElementById('customerResultsTransaction');
    const customerIdTransaction = document.getElementById('customerIdTransaction');

    if (customerSearchTransaction) {
        customerSearchTransaction.addEventListener('input', function () {
            const query = this.value.trim();
            if (query.length < 2) {
                customerResultsTransaction.innerHTML = '';
                customerResultsTransaction.style.display = 'none';
                return;
            }

            fetch(`/customers/search?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(customers => {
                    if (customers.length === 0) {
                        customerResultsTransaction.innerHTML = '<div class="search-result-item">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng</div>';
                        customerResultsTransaction.style.display = 'block';
                        return;
                    }

                    customerResultsTransaction.innerHTML = customers.map(c =>
                        `<div class="search-result-item" data-id="${c.id}" data-name="${c.name}" data-phone="${c.phone}">
                            <strong>${c.name}</strong> - ${c.phone}
                        </div>`
                    ).join('');
                    customerResultsTransaction.style.display = 'block';

                    // Add click handlers
                    document.querySelectorAll('#customerResultsTransaction .search-result-item').forEach(item => {
                        item.addEventListener('click', function () {
                            const id = this.dataset.id;
                            const name = this.dataset.name;
                            const phone = this.dataset.phone;

                            if (id) {
                                customerSearchTransaction.value = `${name} - ${phone}`;
                                customerIdTransaction.value = id;
                                customerResultsTransaction.innerHTML = '';
                                customerResultsTransaction.style.display = 'none';
                            }
                        });
                    });
                })
                .catch(err => console.error(err));
        });

        // Clear on focus
        customerSearchTransaction.addEventListener('focus', function () {
            customerIdTransaction.value = '';
        });
    }

</script>